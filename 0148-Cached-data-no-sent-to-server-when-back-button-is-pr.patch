From fec271aaa0f6c464f88d12a9d70cff5dd59e75ba Mon Sep 17 00:00:00 2001
From: Jason Rogena <jasonrogena@gmail.com>
Date: Mon, 28 Apr 2014 09:52:08 +0300
Subject: [PATCH 148/213] Cached data no sent to server when back button is
 pressed in respective home pages

---
 .../cgiar/ilri/mistro/farmer/EventsActivity.java   | 37 ++++++++++++++++++++++
 .../ilri/mistro/farmer/MilkProductionActivity.java | 31 ++++++++++++++++++
 MistroFarmer/src/main/res/menu/add_event.xml       |  2 +-
 .../src/main/res/menu/add_milk_production.xml      |  2 +-
 MistroFarmer/src/main/res/menu/events.xml          |  2 +-
 MistroFarmer/src/main/res/menu/events_history.xml  |  2 +-
 MistroFarmer/src/main/res/menu/fertility.xml       |  2 +-
 .../src/main/res/menu/milk_procution_history.xml   |  2 +-
 MistroFarmer/src/main/res/menu/milk_production.xml |  2 +-
 9 files changed, 75 insertions(+), 7 deletions(-)

diff --git a/MistroFarmer/src/main/java/org/cgiar/ilri/mistro/farmer/EventsActivity.java b/MistroFarmer/src/main/java/org/cgiar/ilri/mistro/farmer/EventsActivity.java
index 3f988a8..73a21e9 100644
--- a/MistroFarmer/src/main/java/org/cgiar/ilri/mistro/farmer/EventsActivity.java
+++ b/MistroFarmer/src/main/java/org/cgiar/ilri/mistro/farmer/EventsActivity.java
@@ -1,9 +1,12 @@
 package org.cgiar.ilri.mistro.farmer;
 
 import android.content.Intent;
+import android.os.AsyncTask;
 import android.os.Bundle;
 import android.app.Activity;
 import com.actionbarsherlock.view.Menu;
+
+import android.util.Log;
 import android.view.View;
 import android.widget.Button;
 import android.widget.Toast;
@@ -12,10 +15,14 @@ import com.actionbarsherlock.app.SherlockActivity;
 import com.actionbarsherlock.view.MenuInflater;
 import com.actionbarsherlock.view.MenuItem;
 
+import org.cgiar.ilri.mistro.farmer.backend.DataHandler;
 import org.cgiar.ilri.mistro.farmer.backend.Locale;
+import org.json.JSONException;
+import org.json.JSONObject;
 
 public class EventsActivity extends SherlockActivity implements View.OnClickListener
 {
+    private String TAG = "EventsActivity";
 
     private Menu menu;
     private Button addEventB;
@@ -96,9 +103,39 @@ public class EventsActivity extends SherlockActivity implements View.OnClickList
             startActivity(intent);
         }
         else if(view == backB){
+            SendCachedDataThread sendCachedDataThread = new SendCachedDataThread();
+            sendCachedDataThread.execute(1);
+
             Intent intent = new Intent(this, MainMenu.class);
             intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);
             startActivity(intent);
         }
     }
+
+    private class SendCachedDataThread extends AsyncTask<Integer, Integer, Boolean>{
+
+        @Override
+        protected Boolean doInBackground(Integer... params) {
+            String result = DataHandler.sendCachedRequests(EventsActivity.this, true);//send cached data and receive updated farmer data
+            if(result != null && !result.equals(DataHandler.CODE_USER_NOT_AUTHENTICATED)){//no data fetched for this farmer
+                try {//try converting the response into a jsonobject. It might not work if the DataHandler returns a response code
+                    Log.d(TAG, "response is " + result);
+                    DataHandler.saveFarmerData(EventsActivity.this, new JSONObject(result));
+                    return true;
+                } catch (JSONException e) {
+                    e.printStackTrace();
+                }
+            }
+            return false;
+        }
+
+        @Override
+        protected void onPostExecute(Boolean result) {
+            super.onPostExecute(result);
+
+            if(result == true){
+                Toast.makeText(EventsActivity.this, Locale.getStringInLocale("information_successfully_sent_to_server", EventsActivity.this), Toast.LENGTH_LONG).show();
+            }
+        }
+    }
 }
diff --git a/MistroFarmer/src/main/java/org/cgiar/ilri/mistro/farmer/MilkProductionActivity.java b/MistroFarmer/src/main/java/org/cgiar/ilri/mistro/farmer/MilkProductionActivity.java
index 387a17f..b7c28f8 100644
--- a/MistroFarmer/src/main/java/org/cgiar/ilri/mistro/farmer/MilkProductionActivity.java
+++ b/MistroFarmer/src/main/java/org/cgiar/ilri/mistro/farmer/MilkProductionActivity.java
@@ -26,6 +26,7 @@ import com.actionbarsherlock.view.MenuItem;
 import org.cgiar.ilri.mistro.farmer.backend.DataHandler;
 import org.cgiar.ilri.mistro.farmer.backend.Locale;
 import org.cgiar.ilri.mistro.farmer.carrier.Cow;
+import org.cgiar.ilri.mistro.farmer.carrier.MilkProduction;
 import org.json.JSONArray;
 import org.json.JSONException;
 import org.json.JSONObject;
@@ -217,6 +218,9 @@ public class MilkProductionActivity extends SherlockActivity implements View.OnC
             dateETClicked();
         }
         else if(view==backB){
+            SendCachedDataThread sendCachedDataThread = new SendCachedDataThread();
+            sendCachedDataThread.execute(1);
+
             Intent intent = new Intent(this, MainMenu.class);
             intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_SINGLE_TOP);
             startActivity(intent);
@@ -504,4 +508,31 @@ public class MilkProductionActivity extends SherlockActivity implements View.OnC
             }
         }
     }
+
+    private class SendCachedDataThread extends AsyncTask<Integer, Integer, Boolean>{
+
+        @Override
+        protected Boolean doInBackground(Integer... params) {
+            String result = DataHandler.sendCachedRequests(MilkProductionActivity.this, true);//send cached data and receive updated farmer data
+            if(result != null && !result.equals(DataHandler.CODE_USER_NOT_AUTHENTICATED)){//no data fetched for this farmer
+                try {//try converting the response into a jsonobject. It might not work if the DataHandler returns a response code
+                    Log.d(TAG, "response is " + result);
+                    DataHandler.saveFarmerData(MilkProductionActivity.this, new JSONObject(result));
+                    return true;
+                } catch (JSONException e) {
+                    e.printStackTrace();
+                }
+            }
+            return false;
+        }
+
+        @Override
+        protected void onPostExecute(Boolean result) {
+            super.onPostExecute(result);
+
+            if(result == true){
+                Toast.makeText(MilkProductionActivity.this, Locale.getStringInLocale("information_successfully_sent_to_server", MilkProductionActivity.this), Toast.LENGTH_LONG).show();
+            }
+        }
+    }
 }
diff --git a/MistroFarmer/src/main/res/menu/add_event.xml b/MistroFarmer/src/main/res/menu/add_event.xml
index 42c64a9..0dc2157 100644
--- a/MistroFarmer/src/main/res/menu/add_event.xml
+++ b/MistroFarmer/src/main/res/menu/add_event.xml
@@ -9,5 +9,5 @@
           android:showAsAction="never" />
     <item android:id="@+id/action_back_main_menu"
         android:orderInCategory="3"
-        android:showAsAction="ifRoom" />
+        android:showAsAction="never" />
 </menu>
\ No newline at end of file
diff --git a/MistroFarmer/src/main/res/menu/add_milk_production.xml b/MistroFarmer/src/main/res/menu/add_milk_production.xml
index 605e551..07afa94 100644
--- a/MistroFarmer/src/main/res/menu/add_milk_production.xml
+++ b/MistroFarmer/src/main/res/menu/add_milk_production.xml
@@ -9,5 +9,5 @@
         android:showAsAction="never" />
     <item android:id="@+id/action_back_main_menu"
         android:orderInCategory="3"
-        android:showAsAction="ifRoom" />
+        android:showAsAction="never" />
 </menu>
\ No newline at end of file
diff --git a/MistroFarmer/src/main/res/menu/events.xml b/MistroFarmer/src/main/res/menu/events.xml
index 42c64a9..0dc2157 100644
--- a/MistroFarmer/src/main/res/menu/events.xml
+++ b/MistroFarmer/src/main/res/menu/events.xml
@@ -9,5 +9,5 @@
           android:showAsAction="never" />
     <item android:id="@+id/action_back_main_menu"
         android:orderInCategory="3"
-        android:showAsAction="ifRoom" />
+        android:showAsAction="never" />
 </menu>
\ No newline at end of file
diff --git a/MistroFarmer/src/main/res/menu/events_history.xml b/MistroFarmer/src/main/res/menu/events_history.xml
index 42c64a9..0dc2157 100644
--- a/MistroFarmer/src/main/res/menu/events_history.xml
+++ b/MistroFarmer/src/main/res/menu/events_history.xml
@@ -9,5 +9,5 @@
           android:showAsAction="never" />
     <item android:id="@+id/action_back_main_menu"
         android:orderInCategory="3"
-        android:showAsAction="ifRoom" />
+        android:showAsAction="never" />
 </menu>
\ No newline at end of file
diff --git a/MistroFarmer/src/main/res/menu/fertility.xml b/MistroFarmer/src/main/res/menu/fertility.xml
index 605e551..07afa94 100644
--- a/MistroFarmer/src/main/res/menu/fertility.xml
+++ b/MistroFarmer/src/main/res/menu/fertility.xml
@@ -9,5 +9,5 @@
         android:showAsAction="never" />
     <item android:id="@+id/action_back_main_menu"
         android:orderInCategory="3"
-        android:showAsAction="ifRoom" />
+        android:showAsAction="never" />
 </menu>
\ No newline at end of file
diff --git a/MistroFarmer/src/main/res/menu/milk_procution_history.xml b/MistroFarmer/src/main/res/menu/milk_procution_history.xml
index 42c64a9..0dc2157 100644
--- a/MistroFarmer/src/main/res/menu/milk_procution_history.xml
+++ b/MistroFarmer/src/main/res/menu/milk_procution_history.xml
@@ -9,5 +9,5 @@
           android:showAsAction="never" />
     <item android:id="@+id/action_back_main_menu"
         android:orderInCategory="3"
-        android:showAsAction="ifRoom" />
+        android:showAsAction="never" />
 </menu>
\ No newline at end of file
diff --git a/MistroFarmer/src/main/res/menu/milk_production.xml b/MistroFarmer/src/main/res/menu/milk_production.xml
index 42c64a9..0dc2157 100644
--- a/MistroFarmer/src/main/res/menu/milk_production.xml
+++ b/MistroFarmer/src/main/res/menu/milk_production.xml
@@ -9,5 +9,5 @@
           android:showAsAction="never" />
     <item android:id="@+id/action_back_main_menu"
         android:orderInCategory="3"
-        android:showAsAction="ifRoom" />
+        android:showAsAction="never" />
 </menu>
\ No newline at end of file
-- 
2.7.1

